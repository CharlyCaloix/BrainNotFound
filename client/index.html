<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Bot Service Test Interface (BaSTI)</title>
	<style>
		.modal {
		  display: none;
		  position: fixed; 
		  padding-top: 50px;
		  left: 0; 
		  top: 0;
		  width: 100%;
		  height: 100%; 
		  background-color: rgb(0, 0, 0);
		  background-color: rgba(0, 0, 0, 0.5);
		}
		.modal-content {
  			position: relative; 
  			background-color: white;
  			padding: 20px; 
  			margin: auto; 
  			width: 50%;  
		}
	</style>

    <script src="https://unpkg.com/rivescript@latest/dist/rivescript.min.js"></script>
	<script src = "..\TaskServer\index.mjs"></script>
		<script>

		document.addEventListener('DOMContentLoaded',init);

		let botListElt;
		let modal;
		// BOT INPUTS
		let inputName;
		let inputID;
		let inputPath;
		let inputComment;
		let addNewBotButton;
		// CHAT
		let inputQuestionTitle;
		let botOutput;
		let submitInput;

		function init(){
			botListElt = document.getElementById("botListUL");
			modal = document.getElementById("newBotModal");
			personListElt = document.getElementById("personListSELECT")
			inputName = document.getElementById("inputName");
			inputID = document.getElementById("inputID");
			inputPath = document.getElementById("inputPath");
			inputComment = document.getElementById("inputComment");
			// CHAT
			inputQuestionTitle = document.getElementById("inputQuestionTitle");
			botOutput = document.getElementById("botOutput");

			reloadList();
			//setInterval(reloadList,5000);

			newBotButton = document.getElementById("newBotButton");
			newBotButton.addEventListener("click",()=>{modal.style.display = "block";});
			addNewBotButton = document.getElementById("addNewBotButton");
			addNewBotButton.addEventListener("click",createNewBot);

			// CHAT
			submitInput = document.getElementById("submitInput");
			submitInput.addEventListener("click", answerUser);

			// BOT
			var chatbot = new RiveScript();
			chatbot.loadFile("brains/baseBrain.rive").then(botLoaded).catch(botLoadingFailed);

		}


		document.addEventListener('DOMContentLoaded', initPerson);

let personListElt;

// CHAT
function answerUser(){
	let input = inputQuestionTitle.value;
	//console.log(input);
//	let answer = sendRequestToBrain(input);
//	console.log(`Réponse reçue par l'HTML : ${answer}`);

	botOutput.textContent = input;
	//botOutput.textContent = answer;
}

//BOT
function botLoaded(){
	console.log("Chatbot is ready to play with.");
	chatbot.sortReplies();
}

function botLoadingFailed(){
	console.log("Chatbot failed loading.");
}
// ---------------------------------------------

function initPerson() {
    personListElt = document.getElementById("personListUL");
    reloadListPerson();
}

function reloadListPerson() {
    //first, clean up
    while (personListElt.firstChild) {
        personListElt.removeChild(personListElt.firstChild);
    }
    let myHeaders = new Headers();
    myHeaders.append('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
    myHeaders.append('Accept', 'application/json');
    myHeaders.append('Set-Cookie', 'passPhrase=Hop');

    let myInit = {
        method: 'GET',
        headers: myHeaders,
        credentials: 'same-origin',
        mode: 'cors',
        cache: 'no-store'
    };

    let myURL = `http://localhost:3001/persons`;

    fetch(myURL, myInit)
        .then((httpResponse) => {
            for (let field of httpResponse.headers) {
                console.log(`raw = ${field}`);
            }
            return httpResponse.json()
        })
        .then((setOfPersons) => {
            for (let person of setOfPersons) {
                let item = document.createElement("li");
                item.innerHTML += ` ${person.personId}`;
                personListElt.appendChild(item);
            }
        })
        .catch((err) => {
            console.log(`ERROR : ${err}`);
        })
}


		function reloadList(){
			//first, clean up
			while (botListElt.firstChild) {
				botListElt.removeChild(botListElt.firstChild);
			}
			let myHeaders = new Headers();
			myHeaders.append('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
			myHeaders.append('Accept', 'application/json');
			myHeaders.append('Set-Cookie', 'passPhrase=Hop');

			let myInit = { 
				method: 'GET',
               	headers: myHeaders,
               	credentials: 'same-origin',
               	mode: 'cors',
               	cache: 'no-store' 
            };

			let myURL = `http://localhost:3001/bots`;
			
			fetch(myURL,myInit)
				.then((httpResponse)=>{
					for(let field of httpResponse.headers){
						console.log(`raw = ${field}`);
					}	
					return httpResponse.json()
				})
				.then((setOfBots)=>{
					for(let bot of setOfBots){
						botListElt.appendChild(createItem(bot));
					}
				})
				.catch((err)=>{
					console.log(`ERROR : ${err}`);
				})
		}



		function createItem(bot){
			let item = document.createElement("li");
			
			// Adding a DELETE Button
			let delBtn = document.createElement("button");
			delBtn.innerHTML = "DELETE";
			let id = `del_${bot.id}`;
			
			delBtn.setAttribute("id",id);
			delBtn.setAttribute("onclick",`deleteBot(${bot.id})`);
			//delBtn.addEventListener("click",()=>{deleteBot(bot.id)});
			item.appendChild(delBtn);


			// Adding a PUT Button
			let putBtn = document.createElement("button");
			putBtn.innerHTML = "PUT";
			putBtn.setAttribute("onclick",`replaceBot(${bot.id})`);
			//putBtn.addEventListener("click",()=>{replaceBot(bot.id)});
			item.appendChild(putBtn);
			
			// Adding a PATCH Button
			let patchBtn = document.createElement("button");
			patchBtn.innerHTML = "PATCH";
			patchBtn.setAttribute("onclick",`updateBot(${bot.id})`);
			//patchBtn.addEventListener("click",()=>{updateBot(bot.id)});
			item.appendChild(patchBtn);

			item.innerHTML += ` ${bot.name} (ID:${bot.id}), ${bot.comment}`;
			return item;
		}

		function deleteBot(botId){
			
			let myHeaders = new Headers();
			myHeaders.append('Content-Type', 'application/json');

			let myInit = { 
				method: 'DELETE',
               	headers: myHeaders,
               	mode: 'cors',
               	cache: 'default' 
            };
            let myURL = `http://localhost:3001/bots/${botId}`;
			//let myURL = "http://localhost:3001/"+botId;
			fetch(myURL,myInit)
				.then((httpResponse)=>{
					return httpResponse.text()
				})
				.then((returnString)=>{
					reloadList();
					console.log(`All is OK ${returnString}`)
				})
				.catch((err)=>{
					console.log(`ERROR : ${err}`);
				})		
		}

		function replaceBot(botId){
			console.log(`replacing bot with Id ${botId}`);
			//TODO
			//Obvioulsly, you will need to launch a modal
		}

		function updateBot(botId){
			console.log(`updating bot with Id ${botId}`);

			//Create the request
			let myHeaders = new Headers();
			myHeaders.append('Content-Type', 'application/json');
			let payload = {
					name:"Steeve",
					id:botId,
					comment:"Another bot has changed !"
           	};
			let myBody = JSON.stringify(payload);
			let myInit = { 
				method: 'PATCH',
           		headers: myHeaders,
           		mode: 'cors',
           		cache: 'default',
           		body:myBody
        	};
        	let myURL = "http://localhost:3001/bots";

        	//launch the request
			fetch(myURL,myInit)
			.then((httpResponse)=>{
				return httpResponse.text();
			})
			.then((responseBody)=>{
				reloadList();
				//clear fields
				inputName.value="";
				console.log(`response is ${responseBody}`);
			})
			.catch((err)=>{
				console.log(`ERROR : ${err}, ${err.stack}`);
			})	

			//TODO
			//Obvioulsly, you will need to launch a modal
		}

		// Crée un nouveau cerveau avec les données du modal de création
		function createNewBot(){

  			modal.style.display = "none"; // Make the modal disapear

			//Create the request
			console.log(`Input Name value : ${inputName.value}`);
			console.log(`Input ID value : ${inputID.value}`);
			console.log(`Input Path value : ${inputPath.value}`);
			console.log(`Input Comment value : ${inputComment.value}`);

			let myHeaders = new Headers();
			myHeaders.append('Content-Type', 'application/json');
			let payload = {
					name:inputName.value,
					id:inputID.value,
					pathToFile:inputPath.value,
					comment:inputComment.value
           	};
			let myBody = JSON.stringify(payload);
			let myInit = { 
				method: 'POST',
           		headers: myHeaders,
           		mode: 'cors',
           		cache: 'default',
           		body:myBody
        	};
        	let myURL = "http://localhost:3001/bots";

        	//launch the request
			fetch(myURL,myInit)
			.then((httpResponse)=>{
				return httpResponse.text();
			})
			.then((responseBody)=>{
				reloadList();
				//clear fields
				inputName.value="";
				console.log(`response is ${responseBody}`);
			})
			.catch((err)=>{
				console.log(`ERROR : ${err}, ${err.stack}`);
			})		
		}

		// Envoie une question à un cerveau en particulier
		function sendRequestToBrain(question){
			//Create the request
			let myHeaders = new Headers();
			myHeaders.append('Content-Type', 'application/json');
			let payload = {
           			texte:question
           	};
			let myBody = JSON.stringify(payload);
			let myInit = { 
				method: 'POST',
           		headers: myHeaders,
           		mode: 'cors',
           		cache: 'default',
           		body:myBody
        	};
        	let myURL = "http://localhost:3001/bots/word";
			let response;

        	//launch the request
			fetch(myURL,myInit)
			.then((httpResponse)=>{
				console.log(`Retour de la question (then) : ${httpResponse}`);
				return httpResponse.text();
			})
			.then((responseBody)=>{
				console.log(`Retour de la question (then 2) : ${responseBody}`);
				response = responseBody;
				return responseBody;
			})
			.catch((err)=>{
				console.log(`ERROR : ${err}`);
			})

			return response;
		}

	</script>

</head>
<body>

	<ul id="botListUL">
	</ul>

   <ul id="personListUL">
    </ul>

	<button id="newBotButton">ADD A NEW BOT</button>
	<div id="newBotModal" class="modal">
		
		<div class="modal-content">
			<h1>Create a new Bot</h1>
    		<label for="inputName">Name:</label>
    		<input type="text" id="inputName" name="name"></input>

			<label for="inputID">ID:</label>
    		<input type="number" id="inputID" name="id"></input>

			<label for="inputPath">Path of brain:</label>
    		<input type="text" id="inputPath" name="path" value="/brains/baseBrain.rive"></input>

			<label for="inputComment">Comment:</label>
    		<input type="text" id="inputComment" name="Comment"></input>

    		<button id="addNewBotButton">Add This Bot</button>
    	</div>
    	
	</div>
	<div>
		<h1>Talk to a bot</h1>

		<! Poser une question>
		<p>
			<label for="inputQuestionTitle">Question:</label>
			<input type="text" id="inputQuestionTitle" name="Question"></input>
			<button id="submitInput">Ask</button>
		</p>

		<! Avoir une réponse>
		<p>
			Answer : <span id="botOutput"></span>
		</p>

	</div>


</body>
</html>